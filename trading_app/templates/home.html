{% extends "layout.html" %}

{% block title %} {{ titre }} {% endblock %}

{% block head %} 
   {{ super() }}
{% endblock %}

{% block content %}

<div class="main">
    <h1 class="text-center mb-4">Trading App</h1>
    <p class="text-intro">Et interdum acciderat, ut siquid in penetrali secreto nullo citerioris vitae ministro praesente 
        paterfamilias uxori susurrasset in aurem, velut Amphiarao referente aut Marcio, quondam vatibus inclitis, 
        postridie disceret imperator. ideoque etiam parietes arcanorum soli conscii timebantur.</p>
    
    <h3 class="mt-large text-center"> Choose a company</h3>
    <p class="text-intro">A quondam vatibus inclitis, 
        postridie disceret imperator. ideoque etiam parietes arcanorum soli conscii timebantur.</p>

    <div class="prediction_bloc">
        <div class="select_bloc">
            <select class="custom-select" id="select-stock" name="companies">
                {% for symbol, company in companies %}
                    <option value="{{ symbol }}">{{ company }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="predictions">
            <button class="btn btn-light" id="predict-stock" name="predict">Predict</button>
        </div>
    </div>

    <div class="text-center mt-3">
        <p id="result"></p>
    </div>

    <div class="graph_bloc">
        <div id="time_series"></div>
    </div>
    
    

</div>

{% endblock %}

{% block footer %}
    {{ super() }}
{% endblock %}

{% block graph %}
<script>
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

    time_series = document.getElementById('time_series')

    {% autoescape false %}
      var prices = {{ prices }}
      var dates = {{ dates }}
    {% endautoescape %}

    // print default plot
    plot_graph(time_series, dates, prices, "{{ symbol }}")


    // AJAX - reload graph when changing stock
    $(function() {
      $('#select-stock').bind('change', function() {
        var symb = $( "#select-stock option:selected").val()
        $("#result").text("")
        $.getJSON($SCRIPT_ROOT + '/_reload_time_serie', {
          symbol: symb
        }, function(data) {
          // plot
          dates = JSON.parse(data.dates)
          prices = JSON.parse(data.prices)
          plot_graph(time_series, dates, prices, symb)
        });
        return false;
      });

      $('#predict-stock').bind('click', function() {
        var symb = $( "#select-stock option:selected").val()
        $("#result").text("")
        $.getJSON($SCRIPT_ROOT + '/predict', {
          symbol: symb
        }, function(data) {
          console.log(data.result)
          $("#result").text(data.result)
        });
        return false;
      });
    });
    // END AJAX

    function plot_graph(tag, dates, prices, symbol) {
      var trace = {
        x: dates,
        y: prices,
        mode: 'lines',
        line: {
            color: 'rgb(155, 106, 108)',
            width: 2
        },
        name : symbol
    };

      var data = [trace];

      var layout = {
        title: {
            text:'Stock Price for ' + symbol,
            font: {
            family: 'inherit',
                size: 24
            },
            xref: 'paper',
            x: 0.05,
        },
        xaxis: {
            title: {
                text: 'Time',
                font: {
                    family: 'inherit',
                    size: 15,
                    color: '#7f7f7f'
                }
            },
        },
        yaxis: {
            title: {
                text: 'Price',
                font: {
                    family: 'inherit',
                    size: 15,
                    color: '#7f7f7f'
                }
            }
        },
        showlegend: true,
        legend: {
          x: 1,
          xanchor: 'right',
          y: 1
        }
      };
      Plotly.newPlot(tag, data, layout);
    }
    </script>
{% endblock %}